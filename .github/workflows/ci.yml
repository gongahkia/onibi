name: Onibi CI/CD and .DMG release on push

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: macos-14
    strategy:
      matrix:
        xcode-version: ["15.0", "15.4"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ matrix.xcode-version }}

      - name: Show Swift version
        run: swift --version

      - name: Install SwiftLint
        run: brew install swiftlint

      - name: Run SwiftLint
        run: swiftlint lint --strict --reporter github-actions-logging

      - name: Build Debug
        run: swift build -c debug

      - name: Run Tests
        run: swift test

      - name: Build Release
        run: swift build -c release

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Onibi-${{ matrix.xcode-version }}-${{ github.sha }}
          path: .build/release/Onibi
          retention-days: 7

  release:
    name: Create Release
    runs-on: macos-14
    needs: build-and-test
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "15.0"

      - name: Build Release
        run: swift build -c release

      - name: Create App Bundle
        run: |
          # Create app bundle structure
          mkdir -p Onibi.app/Contents/MacOS
          mkdir -p Onibi.app/Contents/Resources

          # Copy executable
          cp .build/release/Onibi Onibi.app/Contents/MacOS/

          # Create Info.plist
          cat > Onibi.app/Contents/Info.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>Onibi</string>
              <key>CFBundleIdentifier</key>
              <string>com.onibi.app</string>
              <key>CFBundleName</key>
              <string>Onibi</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleShortVersionString</key>
              <string>1.0.0</string>
              <key>CFBundleVersion</key>
              <string>1</string>
              <key>LSMinimumSystemVersion</key>
              <string>14.0</string>
              <key>LSUIElement</key>
              <true/>
              <key>NSHighResolutionCapable</key>
              <true/>
              <key>NSPrincipalClass</key>
              <string>NSApplication</string>
          </dict>
          </plist>
          EOF

          # Copy icon if exists
          if [ -f "asset/icon.icns" ]; then
            cp asset/icon.icns Onibi.app/Contents/Resources/AppIcon.icns
          fi

      - name: Create DMG
        run: |
          mkdir -p dmg-contents
          cp -R Onibi.app dmg-contents/
          hdiutil create -volname "Onibi" -srcfolder dmg-contents -ov -format UDZO Onibi-unsigned.dmg

      - name: Code Sign and Prepare DMG
        env:
          DEVELOPER_ID_CERTIFICATE: ${{ secrets.DEVELOPER_ID_CERTIFICATE }}
          DEVELOPER_ID_CERTIFICATE_PASSWORD: ${{ secrets.DEVELOPER_ID_CERTIFICATE_PASSWORD }}
        run: |
          if [ -n "$DEVELOPER_ID_CERTIFICATE" ]; then
            echo "Signing DMG with Developer ID certificate..."
            # Import Developer ID certificate
            echo "$DEVELOPER_ID_CERTIFICATE" | base64 --decode > certificate.p12
            security create-keychain -p actions build.keychain
            security default-keychain -s build.keychain
            security unlock-keychain -p actions build.keychain
            security import certificate.p12 -k build.keychain -P "$DEVELOPER_ID_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
            security set-key-partition-list -S apple-tool:,apple: -s -k actions build.keychain
            
            # Sign the DMG for Gatekeeper compatibility
            codesign --force --sign "Developer ID Application" --timestamp Onibi-unsigned.dmg
            mv Onibi-unsigned.dmg Onibi.dmg
            
            # Verify signature
            codesign --verify --verbose Onibi.dmg
            
            # Clean up
            security delete-keychain build.keychain
            rm certificate.p12
          else
            echo "No Developer ID certificate configured, using unsigned DMG..."
            mv Onibi-unsigned.dmg Onibi.dmg
          fi

      - name: Notarize DMG
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          if [ -n "$APPLE_ID" ] && [ -n "$APPLE_ID_PASSWORD" ] && [ -n "$APPLE_TEAM_ID" ]; then
            echo "Submitting DMG for notarization..."
            xcrun notarytool submit Onibi.dmg \
              --apple-id "$APPLE_ID" \
              --password "$APPLE_ID_PASSWORD" \
              --team-id "$APPLE_TEAM_ID" \
              --wait
            
            # Staple the notarization ticket to the DMG
            echo "Stapling notarization ticket..."
            xcrun stapler staple Onibi.dmg
            
            # Verify stapling
            echo "Verifying stapled notarization..."
            xcrun stapler validate Onibi.dmg
          else
            echo "Notarization credentials not configured, skipping notarization..."
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: Onibi.dmg
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
