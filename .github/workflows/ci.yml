name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: macos-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.0'
      
      - name: Show Xcode version
        run: xcodebuild -version
      
      - name: Install SwiftLint
        run: brew install swiftlint
      
      - name: Run SwiftLint
        run: swiftlint lint --strict --reporter github-actions-logging
        continue-on-error: true
      
      - name: Build
        run: |
          xcodebuild build \
            -project GhosttyMenubar.xcodeproj \
            -scheme GhosttyMenubar \
            -configuration Debug \
            -destination 'platform=macOS' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO
      
      - name: Run Tests
        run: |
          xcodebuild test \
            -project GhosttyMenubar.xcodeproj \
            -scheme GhosttyMenubar \
            -destination 'platform=macOS' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO
        continue-on-error: true
      
      - name: Build Release
        run: |
          xcodebuild build \
            -project GhosttyMenubar.xcodeproj \
            -scheme GhosttyMenubar \
            -configuration Release \
            -destination 'platform=macOS' \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO
      
      - name: Create App Bundle
        run: |
          mkdir -p artifacts
          cp -R build/Build/Products/Release/GhosttyMenubar.app artifacts/
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: GhosttyMenubar-${{ github.sha }}
          path: artifacts/GhosttyMenubar.app
          retention-days: 7

  release:
    name: Create Release
    runs-on: macos-latest
    needs: build-and-test
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.0'
      
      - name: Build Release
        run: |
          xcodebuild build \
            -project GhosttyMenubar.xcodeproj \
            -scheme GhosttyMenubar \
            -configuration Release \
            -destination 'platform=macOS' \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO
      
      - name: Create DMG
        run: |
          mkdir -p dmg-contents
          cp -R build/Build/Products/Release/GhosttyMenubar.app dmg-contents/
          hdiutil create -volname "GhosttyMenubar" -srcfolder dmg-contents -ov -format UDZO GhosttyMenubar.dmg
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: GhosttyMenubar.dmg
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
